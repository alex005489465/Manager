# 評論分析表建立過程記錄

## 需求背景

在完成永大夜市評論資料匯入後，我們需要進一步分析評論內容。原始的 `reviews` 表包含了所有評論，但其中有些評論沒有內容（snippet為空），有些則包含豐富的文字描述。

為了更有效地進行分析，我們決定建立一個專門的分析表來：
1. **篩選有內容的評論** - 只保留有實際文字內容的評論
2. **標記專案相關性** - 為後續判別是否與我們專案相關預留欄位
3. **提升查詢效能** - 建立適當索引加速分析查詢

## 表結構設計

### 表名選擇過程
經過討論，從以下選項中選擇了 `review_analysis`：

**考慮過的表名：**
- `review_content_filter` - 原始名稱，較冗長
- `review_analysis` - **最終選擇**，簡潔且語意清晰
- `content_analysis` - 備選方案
- `processed_reviews` - 流程導向命名

**選擇理由：**
- 語意清晰，明確表達用途
- 簡潔易懂，符合命名規範
- 擴展性佳，未來可加入更多分析欄位

### 最終表結構

```sql
CREATE TABLE review_analysis (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '統一自增主鍵',
    review_id BIGINT COMMENT '關聯原reviews表的id',
    content TEXT COMMENT '評論內容（複製自reviews.snippet）',
    is_project_related BOOLEAN DEFAULT NULL COMMENT '是否跟專案相關（NULL=未判別, TRUE=相關, FALSE=不相關）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '建立時間',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='評論分析表 - 存儲有內容的評論及專案相關性標示';
```

### 重要修正記錄

**review_id 欄位修正：**
- **問題**：最初設計為 `VARCHAR(100)`，關聯到 `reviews.review_id`
- **修正**：改為 `BIGINT`，關聯到 `reviews.id`（主鍵）
- **原因**：使用主鍵關聯更有效率，避免字串比對的效能損耗

## 索引設計

建立了三個關鍵索引：

1. **idx_review_analysis_review_id** - 關聯查詢索引
2. **idx_review_analysis_project_related** - 專案相關性篩選索引
3. **idx_review_analysis_created_at** - 時間排序索引

## 資料匯入邏輯

```sql
INSERT INTO review_analysis (review_id, content)
SELECT
    id,
    snippet
FROM reviews
WHERE snippet IS NOT NULL
    AND snippet != ''
    AND TRIM(snippet) != '';
```

**篩選條件說明：**
- `snippet IS NOT NULL` - 排除NULL值
- `snippet != ''` - 排除空字串
- `TRIM(snippet) != ''` - 排除只有空白字元的內容

## 檔案位置

SQL腳本檔案：`src/data-clean/docs/sql/03-create-review-filter-table.sql`

## 使用指南

1. **執行環境**：phpMyAdmin
2. **執行權限**：可使用 `manager_reviews_user` 執行
3. **前置條件**：需先執行資料庫和表建立腳本
4. **執行方式**：直接在phpMyAdmin中執行完整腳本

## 預期結果

執行完成後應該得到：
- 一個包含所有有內容評論的 `review_analysis` 表
- 所有 `is_project_related` 欄位為 NULL（待後續分析）
- 適當的索引以支援高效查詢

## 後續工作

1. 實作專案相關性判別邏輯
2. 更新 `is_project_related` 欄位
3. 基於分析結果進行進一步的資料探索