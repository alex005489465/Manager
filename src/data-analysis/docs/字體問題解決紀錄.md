# matplotlib 中文字體問題解決紀錄

## 問題描述
- 程式運行正常，無報錯，但生成的圖表中所有中文文字顯示為方框
- 包括圖表標題、軸標籤、料理名稱等所有中文內容都無法正常顯示
- 儘管設定了警告抑制，但實際字體並未生效

## 問題表現
1. 圖表中中文文字全部顯示為 □□□□ 方框
2. 程式運行時有大量 matplotlib 字體警告（後來被抑制）
3. 日誌顯示「設定中文字體: Noto Sans TC」但實際無效果

## 排查過程

### 1. 初步檢查
- 確認系統有 Noto Sans TC 和 Noto Sans HK 字體
- 檢查 matplotlib 可用字體列表，發現目標字體存在
- 清除 matplotlib 字體快取並重建

### 2. 深入調查
- 搜索專案中所有字體設定相關的程式碼
- 檢查字體設定的時機和位置
- 發現字體在模組導入時設定，但在圖表創建時被重置

### 3. 根因分析
- 定位到 `base_chart.py` 中的問題
- 發現 `BaseChart.__init__()` 中的 `plt.style.use('default')` 會重置所有 matplotlib 設定
- 字體設定在模組導入時完成，但每次創建圖表時被覆蓋

## 根本原因
**`plt.style.use('default')` 重置字體設定**
- 字體在模組導入時設定（第31-33行）
- 每次創建圖表時，`BaseChart.__init__()` 調用 `plt.style.use('default')`
- 這會重置所有 rcParams，包括字體設定
- 導致中文字體被重置為預設的 DejaVu Sans

## 解決方案
**在樣式設定後重新配置字體**
1. 移除模組導入時的字體設定
2. 在 `BaseChart.__init__()` 中，於 `plt.style.use('default')` **之後** 重新設定中文字體
3. 確保每次創建圖表時都會正確設定字體

## 修改位置
- 檔案：`src/data-analysis/visualization/charts/base_chart.py`
- 位置：`BaseChart.__init__()` 方法中
- 時機：在 `plt.style.use('default')` 和 `sns.set_palette()` 之後

## 驗證結果
1. 所有圖表中文字體正確顯示
2. 程式運行無任何警告
3. 日誌顯示多次「重新設定中文字體: Noto Sans TC」確認設定生效
4. 測試圖表證實中文渲染正常

## 經驗總結
1. **時機很重要**：字體設定必須在樣式重置之後進行
2. **測試要全面**：單純沒有錯誤不代表功能正常
3. **排查要深入**：需要理解各組件的執行順序和影響
4. **驗證要徹底**：修改後要檢查實際輸出效果

## 預防措施
- 任何會重置 matplotlib 設定的操作後，都要重新設定字體
- 建議在圖表類別的初始化中統一處理字體設定
- 定期檢查生成的圖表實際顯示效果