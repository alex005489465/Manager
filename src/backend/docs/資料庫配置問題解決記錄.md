# 資料庫配置問題解決記錄

## 📅 時間
2025-09-24

## 🔍 問題概述
Spring Boot 應用啟動時遇到資料庫連線配置問題，導致應用無法正常啟動並存取資料庫。

## ⚠️ 主要問題

### 1. Repository 掃描衝突
**問題描述**：`extractedFoodItemRepository` 被多個配置類同時掃描
- `Application.java` 中的 `@EnableJpaRepositories`
- `ReviewsRepositoryConfig.java` 中的 `@EnableJpaRepositories`

**解決方案**：移除 `ReviewsRepositoryConfig.java` 中的重複配置，讓主應用類統一處理掃描

### 2. Entity 掃描配置衝突
**問題描述**：EntityManagerFactory 配置中出現重複的實體掃描設定

**解決方案**：統一由 `Application.java` 的 `@EntityScan` 處理，移除個別 EntityManagerFactory 的重複掃描

### 3. HikariCP 資料庫連線配置錯誤
**問題描述**：`application.yml` 中使用 `url` 參數，但 HikariCP 要求使用 `jdbc-url`
```
錯誤訊息：jdbcUrl is required with driverClassName
```

**解決方案**：將所有 `spring.datasource.*.url` 修改為 `spring.datasource.*.jdbc-url`

### 4. 端口衝突問題
**問題描述**：多個 Spring Boot 實例同時運行導致端口 8080 被占用

**解決方案**：重啟容器清理所有背景進程，確保端口可用

## ✅ 最終正常配置

### application.yml 關鍵配置
```yaml
spring:
  datasource:
    reviews:
      jdbc-url: jdbc:mysql://mysql:3306/manager_reviews_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Taipei
      username: manager_user
      password: manager_secure_password
      driver-class-name: com.mysql.cj.jdbc.Driver
```

### Application.java 統一掃描配置
```java
@EnableJpaRepositories(basePackages = "modules")
@EntityScan(basePackages = "modules")
```

## 🔧 成功驗證結果

### 1. 資料庫連線成功
- HikariPool 連線池正常啟動：`HikariPool-1 - Start completed`
- JPA EntityManagerFactory 初始化成功
- Repository 掃描發現 1 個 JPA repository 介面

### 2. API 功能測試通過
- **GET /api/food-items**：成功返回 396 筆資料，分頁正常
- **分頁查詢**：`?page=2&pageSize=5` 正確返回第2頁資料
- **健康檢查**：`/api/health` 返回 `{"status":"UP"}`

### 3. 應用正常運行
- 容器內 8080 端口運行，對外映射 8081 端口
- Spring Boot 完整啟動時間約 22 秒
- 所有配置檢查通過，無嚴重錯誤

## 📋 未來注意事項

### 1. 配置管理原則
- **統一掃描策略**：讓主應用類處理所有 Repository 和 Entity 掃描
- **避免重複配置**：不同配置類間避免功能重疊
- **配置職責分離**：每個配置類專注單一職責

### 2. 資料庫連線配置
- **HikariCP 參數**：使用 `jdbc-url` 而非 `url`
- **連線池監控**：定期檢查 HikariPool 狀態
- **連線參數優化**：根據實際需求調整連線池大小

### 3. 容器化開發注意點
- **端口管理**：確保容器重啟時清理舊進程
- **資源隔離**：避免多個應用實例同時運行
- **日誌監控**：定期檢查應用啟動日誌

### 4. 開發流程建議
- **配置變更測試**：任何資料庫配置變更都需要完整測試
- **分層驗證**：從連線 → 實體掃描 → Repository → API 逐層驗證
- **問題隔離**：遇到問題時先隔離具體原因再修復

## 🎯 問題解決關鍵
1. **系統性排查**：從資料庫連線開始逐步檢查每一層配置
2. **配置簡化**：移除重複和衝突的配置，保持配置清晰
3. **遵循框架約定**：使用 Spring Boot 推薦的配置方式
4. **充分測試**：修改後進行完整的功能驗證

---
**維護者**：後端開發團隊
**文件版本**：v1.0
**最後更新**：2025-09-24