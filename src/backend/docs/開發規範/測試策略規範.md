# 測試策略規範

## 📋 文件目的

本文件定義後端專案的測試策略、偏差處理機制與品質保證方法，確保實現與設計文件完全一致。

## 🧪 核心測試哲學

### 規範驗證驅動測試 (Specification-Driven Testing)

**核心理念：**
測試的目標是**發現實現與設計文件的偏差**，而非掩蓋問題。每個測試失敗都是一個學習與改進的機會。

**測試流程：**
```
設計文件 → 測試案例 → 實現驗證 → 偏差識別 → 決策討論 → 規範或實現調整
```

**測試失敗的正面意義：**
- 測試失敗 = 發現規範與實現不一致
- 需要的是**討論與決策**，而非修改測試讓其通過
- 每個偏差都需要明確的決策記錄

### 測試優先順序

**按重要性排序：**
1. **規範符合性測試** - 驗證實現是否符合設計文件
2. **業務邏輯測試** - 驗證業務規則正確執行
3. **API契約測試** - 驗證API回應格式符合設計文件
4. **邊界值測試** - 驗證數值限制和邊界條件

## 📊 測試覆蓋率目標

### 覆蓋率指標

**分層覆蓋率目標：**
- **整體程式碼覆蓋率：≥ 80%**
- **核心業務邏輯：≥ 90%**
- **Controller層：≥ 70%**（主要測試API契約）
- **Service層：≥ 90%**（業務邏輯重點）
- **Repository層：≥ 60%**（主要測試複雜查詢）

### 品質重於覆蓋率

**測試完整性要求：**
- ✅ 所有設計文件定義的業務規則都有測試
- ✅ 所有邊界值和限制條件都有驗證
- ✅ 所有異常情況都有處理測試
- ✅ 100% 規範覆蓋率：所有實現都能對應到規範條目
- ✅ 零超範圍功能：沒有任何規範外的功能實現

## 🔧 測試實施策略

### Mock使用原則

**✅ 建議Mock：**
- 外部服務呼叫
- 複雜的Repository查詢（單元測試時）
- 時間相關的邏輯（使用Clock Mock）

**❌ 避免Mock：**
- 簡單的POJO物件
- Spring框架本身的組件
- 實際的業務邏輯實現

### 整合測試策略

**完整整合測試範例：**
```java
@SpringBootTest
@TestPropertySource(locations = "classpath:application-test.yml")
@Sql(scripts = "/test-data/recipe-test-data.sql", executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD)
@Sql(scripts = "/test-data/cleanup.sql", executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD)
class RecipeServiceIntegrationTest {
    
    @Autowired
    private RecipeService recipeService;
    
    @Test
    void createRecipe_shouldFollowSpecification() {
        // @Spec: user-flow.md:102-115 - 完整配方創建流程測試
        CreateRecipeRequest request = CreateRecipeRequest.builder()
            .name("測試配方") // @Spec: model-validation.md:24-26 - 名稱長度限制
            .description("測試描述") // @Spec: model-validation.md:27-29 - 描述長度限制
            .build();
            
        Recipe result = recipeService.createRecipe(request);
        
        // 驗證結果符合設計文件規範
        assertThat(result.getName()).isEqualTo("測試配方");
        assertThat(result.getId()).isNotNull(); // @Spec: model-validation.md:23 - 主鍵生成
        assertThat(result.getDescription()).isEqualTo("測試描述");
    }
    
    @Test
    void createRecipe_withInvalidName_shouldThrowValidationException() {
        // @Spec: model-validation.md:25 - 名稱長度不能超過100字元
        String longName = "a".repeat(101);
        CreateRecipeRequest request = CreateRecipeRequest.builder()
            .name(longName)
            .build();
            
        assertThatThrownBy(() -> recipeService.createRecipe(request))
            .isInstanceOf(BusinessException.class)
            .hasMessageContaining("配方名稱不能超過100個字元");
    }
}
```

### 單元測試策略

**Service層單元測試範例：**
```java
@ExtendWith(MockitoExtension.class)
class RecipeServiceUnitTest {
    
    @Mock
    private RecipeRepository recipeRepository;
    
    @InjectMocks
    private RecipeService recipeService;
    
    @Test
    void createRecipe_shouldSaveWithCorrectData() {
        // @Spec: user-flow.md:108-112 - 配方創建業務邏輯
        CreateRecipeRequest request = CreateRecipeRequest.builder()
            .name("單元測試配方")
            .description("單元測試描述")
            .build();
            
        Recipe expectedSavedRecipe = Recipe.builder()
            .id(1L)
            .name("單元測試配方")
            .description("單元測試描述")
            .build();
            
        when(recipeRepository.save(any(Recipe.class))).thenReturn(expectedSavedRecipe);
        
        Recipe result = recipeService.createRecipe(request);
        
        verify(recipeRepository).save(argThat(recipe -> 
            recipe.getName().equals("單元測試配方") &&
            recipe.getDescription().equals("單元測試描述")
        ));
        assertThat(result).isEqualTo(expectedSavedRecipe);
    }
}
```

## 🎯 測試案例管理

### 測試類型分類

**規範契約測試：**
- 驗證實現是否符合規範要求
- 每個API端點都有對應的契約測試
- 回應格式必須完全符合設計文件

**邊界值測試：**
- 驗證所有規範定義的邊界值
- 測試最小值、最大值、邊界值±1
- 特殊值測試（null, empty, 特殊字元）

**負面測試：**
- 驗證規範禁止的操作確實被阻止
- 測試無效參數和錯誤條件
- 驗證錯誤訊息符合設計文件要求

**範圍測試：**
- 驗證功能範圍不超出規範定義
- 確保沒有實現規範外的功能
- 檢查所有功能都有對應的@Spec標註

## 📝 偏差處理機制

### 偏差識別與記錄

**偏差記錄格式：**
```markdown
## 偏差記錄 #001
- **發現日期：** 2025-09-07
- **發現方式：** 整合測試失敗
- **偏差類型：** API回應格式與設計文件不符
- **具體描述：** createRecipe API回傳的timestamp格式為ISO8601，但設計文件要求Unix時間戳
- **影響評估：** 中等 - 影響前端解析，但不影響核心功能
- **決策狀態：** 待討論
- **相關文件：** api-design.md:59-65, RecipeController.java:25
- **相關測試：** RecipeControllerTest.createRecipe_shouldReturnCorrectFormat()
```

### 偏差處理流程

**標準處理步驟：**
1. **偏差識別** - 通過測試失敗或程式碼審查發現
2. **詳細記錄** - 使用標準格式記錄偏差資訊
3. **影響評估** - 評估偏差對專案的影響程度（高/中/低）
4. **團隊討論** - 決定是修正規範還是修正實現
5. **執行修正** - 按照決策結果進行修正
6. **記錄決策** - 記錄決策理由與考量
7. **驗證修正** - 確保修正後測試通過且無副作用

## 🔄 偏差監控機制

### 持續監控策略

**自動化監控：**
- 每次測試執行後檢查新的偏差
- CI/CD流程中整合規範符合性檢查
- 自動生成偏差報告

**定期審查：**
- 定期審查已知偏差的處理狀態
- 追蹤偏差修正的效果與影響
- 建立偏差預防機制

### 品質改進流程

**持續改進循環：**
1. **問題識別** - 通過測試、審查、使用回饋發現問題
2. **根因分析** - 分析問題的根本原因
3. **解決方案** - 制定具體的改進措施
4. **實施改進** - 執行改進措施
5. **效果評估** - 評估改進效果並持續優化

## 📊 品質保證指標

### 開發品質指標

**技術指標：**
- ✅ 100% 規範覆蓋率：所有實現都能對應到規範條目
- ✅ 零超範圍功能：沒有任何規範外的功能實現
- ✅ 嚴格邊界遵守：所有數值限制完全按規範設定
- ✅ 完整@Spec標註：所有關鍵實現都有設計文件引用

### 協作效果指標

**團隊協作指標：**
- ✅ 跨組一致性：與前端、資料庫團隊實現完全一致
- ✅ 溝通效率：減少因理解差異導致的溝通成本
- ✅ 集成順暢：各模組間介面完美匹配
- ✅ 維護便利：規範更新能快速同步到實現

## 🛠 測試環境配置

### 測試資料管理

**H2內存資料庫配置：**
```yaml
# application-test.yml
spring:
  datasource:
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
    username: sa
    password: password
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
  sql:
    init:
      mode: always
```

**測試資料初始化：**
```sql
-- test-data/recipe-test-data.sql
INSERT INTO recipes (id, name, description, created_at) VALUES 
(1, '測試配方1', '測試描述1', CURRENT_TIMESTAMP),
(2, '測試配方2', '測試描述2', CURRENT_TIMESTAMP);
```

**資料隔離策略：**
- 每個測試方法前後執行清理腳本
- 使用@Transactional自動回滾
- 確保測試間完全獨立

## ❌ 錯誤的測試做法

**避免以下測試反模式：**
- ❌ 修改測試資料或測試邏輯來讓測試通過
- ❌ 為了避免測試失敗而降低測試標準
- ❌ 忽視邊界值測試中的失敗
- ❌ 測試程式碼實現而非業務需求
- ❌ 過度使用Mock導致測試不真實

## ✅ 正確的測試做法

**推薦的測試最佳實踐：**
- ✅ 使用測試來找出實現與規範的偏差
- ✅ 詳細記錄每個測試失敗的原因
- ✅ 基於測試結果進行團隊討論與決策
- ✅ 測試業務需求而非實現細節
- ✅ 保持測試簡單、可讀、可維護

---

**版本：** v1.0.0  
**建立日期：** 2025-09-07  
**狀態：** ✅ 測試策略規範制定完成  
**適用範圍：** 所有後端開發與測試工作  
**維護責任：** 後端開發團隊與品質保證團隊