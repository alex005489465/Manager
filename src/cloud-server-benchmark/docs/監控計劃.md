# 雲伺服器監控計劃

## 🎯 監控目標

對雲伺服器性能測試環境進行實時監控，使用 Prometheus + Grafana 提供即時可視化和數據存儲。

### 核心策略
- **本地監控中心** - Prometheus + Grafana 運行在本地
- **實時可視化** - 即時監控儀表板和告警
- **業界標準** - 使用 Prometheus 生態系統
- **零雲端資源** - 監控不占用測試伺服器資源

## 🏗️ 監控架構設計

### 架構概述
```
本地環境:
├── Prometheus Server    # 數據收集和存儲
├── Grafana             # 可視化儀表板
└── Blackbox Exporter   # 網路探測

雲端伺服器:
├── bench-1 → node_exporter
├── test    → node_exporter
└── bench-2 → node_exporter
```

### 數據流向
- **Exporters** → **Prometheus** → **Grafana**
- 本地 Prometheus 定期拉取三台伺服器的 metrics
- Grafana 從 Prometheus 查詢數據進行可視化

## 📊 監控項目規劃

### 監控組件配置

**node_exporter (所有節點)**
- **CPU指標：** 使用率、負載、上下文切換
- **記憶體指標：** 總量、已用、可用、緩存、交換區
- **磁碟指標：** IOPS、讀寫吞吐量、使用率、佇列深度
- **網路指標：** 封包數、錯誤率、頻寬使用
- **系統指標：** 開機時間、檔案描述符、程序數

**blackbox_exporter (本地)**
- **HTTP探測：** 服務可用性、回應時間
- **TCP探測：** 端口連通性、連接時間
- **ICMP探測：** ping延遲、封包丟失率

## 🔧 實作方式

### 本地環境設置
**Prometheus 配置**
- **抓取間隔：** 10秒（平衡精度與資源使用）
- **數據保留：** 30天（足夠詳細分析）
- **儲存格式：** 時間序列資料庫，支援 PromQL 查詢

**Grafana 配置**
- **資料源：** 連接本地 Prometheus
- **儀表板：** 分類顯示系統和網路指標
- **告警設置：** 資源使用異常通知

### 雲端 Exporters 部署
**標準化安裝**
- **Docker 容器化：** 統一部署和管理
- **安全配置：** 僅開放必要監控端口
- **自動重啟：** 確保監控持續性

### 採集頻率策略
- **Prometheus 全域：** 10秒抓取間隔
- **node_exporter：** 10秒間隔，系統資源指標
- **blackbox_exporter：** 30秒間隔，網路探測

### 數據格式
```prometheus
# CPU 使用率範例
node_cpu_seconds_total{cpu="0",mode="user",instance="bench-1:9100"} 1234.56

# 記憶體使用率範例
node_memory_MemAvailable_bytes{instance="bench-1:9100"} 8589934592

# 網路流量範例
node_network_receive_bytes_total{device="eth0",instance="bench-1:9100"} 123456789
```

## 🚀 部署流程

### 階段1: 本地環境設置（5分鐘）
1. **安裝 Docker Desktop**（如未安裝）
2. **配置 Prometheus targets**（替換三台雲伺服器IP地址）
3. **部署監控服務**
   ```bash
   docker-compose up -d
   ```
4. **驗證本地服務**
   - Prometheus: http://localhost:9090
   - Grafana: http://localhost:3000

### 階段2: 雲端 Exporters 部署（10分鐘）
1. **所有節點安裝系統監控**
   ```bash
   # 在 bench-1, test, bench-2 執行
   docker-compose -f docker-compose.cloud.yml up -d node-exporter
   ```
2. **驗證監控端點**可達性（端口 9100）

### 階段3: 監控驗證（5分鐘）
1. **檢查 Prometheus targets** 狀態（全部 UP）
2. **確認 Grafana 儀表板** 顯示數據
3. **測試網路探測功能**

## 📁 監控配置結構

```
monitoring/
├── docker-compose.yml              # 本地監控服務
├── prometheus/
│   ├── prometheus.yml              # Prometheus 配置
│   └── rules/                      # 告警規則檔案
├── grafana/
│   ├── provisioning/               # 自動配置
│   └── dashboards/                 # 儀表板 JSON
└── exporters/
    ├── docker-compose.cloud.yml    # 雲端 node-exporter
    └── blackbox.yml                # 網路探測配置
```

## ⚠️ 重要注意事項

### 網路需求
- 確保本地環境能訪問三台雲伺服器的監控端口
- 建議使用 VPN 或專線，避免公網暴露監控端口
- 監控端口：9100 (node_exporter)

### 安全考量
- **端口限制：** 僅對本地 IP 開放監控端口
- **認證機制：** 可配置 basic auth 或 TLS 加密
- **防火牆設定：** 適當限制訪問來源

### 性能影響
- Node Exporter 資源消耗極低（<1% CPU, <50MB RAM）
- 10秒抓取間隔對性能影響可忽略
- 純系統級監控，不影響應用程式測試

### 故障處理
- **監控服務故障：** 不中斷測試執行
- **網路中斷：** Prometheus 自動重試和補償
- **部分節點失效：** 其他節點數據仍可分析

### 數據持久性
- **本地儲存：** Prometheus 數據保存30天
- **備份機制：** 可定期匯出重要時間段數據
- **查詢優化：** 使用 PromQL 進行高效數據分析

---

**建立日期：** 2025-09-28
**更新日期：** 2025-09-28（簡化為系統級監控）
**預估部署時間：** 20分鐘
**預估本地儲存：** 約200MB（30天數據）
**採集頻率：** 10秒（系統監控）/ 30秒（網路探測）
**監控端口：** 9090 (Prometheus), 3000 (Grafana), 9100 (Node Exporter)