# 雲伺服器監控計劃

## 🎯 監控目標

對雲伺服器性能測試環境進行系統監控，採集原始數據供後續本地分析使用。

### 核心策略
- **純資料採集** - 不做即時分析或告警
- **結構化輸出** - CSV格式，便於後續處理
- **最小部署** - 腳本化實現，減少依賴
- **本地分析** - 數據打包下載，離線分析

## 🏗️ 監控架構設計

### 部署分工
- **bench-1：** 監控MySQL容器 + 本機系統資源
- **test：** 監控sysbench容器 + 本機系統資源
- **bench-2：** 不使用

### 獨立運作
- 各節點監控腳本獨立執行
- 不需要節點間通信
- 測試結束後分別打包下載

## 📊 監控項目規劃

### bench-1 監控內容

**系統資源監控（每10秒）**
- **CPU使用率：** 各核心負載分佈
- **記憶體使用：** 總量、已用、緩存、交換區
- **磁碟I/O：** IOPS、讀寫吞吐量、佇列深度
- **網路I/O：** 封包數、頻寬使用

**容器資源監控（每30秒）**
- **MySQL-CPU容器：** CPU、記憶體、網路使用
- **MySQL-Memory容器：** CPU、記憶體、網路使用
- **MySQL-Disk容器：** CPU、記憶體、網路使用

**MySQL應用監控（每60秒）**
- **連接統計：** 當前連接數、最大連接數
- **查詢統計：** 總查詢數、QPS計算
- **緩存統計：** Buffer Pool命中率、使用量
- **引擎統計：** InnoDB讀寫統計

### test 監控內容

**系統資源監控（每10秒）**
- **CPU使用率：** 各核心負載分佈
- **記憶體使用：** 總量、已用、緩存、交換區
- **磁碟I/O：** IOPS、讀寫吞吐量、佇列深度
- **網路I/O：** 封包數、頻寬使用

**容器資源監控（每30秒）**
- **sysbench容器：** CPU、記憶體、網路使用

**網路品質監控（每30秒）**
- **延遲測試：** ping到bench-1的RTT
- **連線狀態：** MySQL連接是否正常

## 🔧 實作方式

### 採集工具
- **系統監控：** `vmstat`, `free`, `iostat`, `sar`
- **容器監控：** `docker stats`
- **MySQL監控：** `mysql -e "SHOW STATUS"`
- **網路監控：** `ping`, `ss`

### 腳本特色
- **背景執行：** 不干擾測試進行
- **分層採集：** 不同監控項目使用不同頻率
- **錯開時間：** 避免同時採集造成資源競爭
- **統一時間戳：** 便於後續時間軸對齊
- **自動停止：** 測試結束自動終止
- **資料分類：** 按類型分檔案存放

### 採集頻率策略
- **系統資源：** 每10秒（最重要，高精度捕捉性能變化）
- **容器資源：** 每30秒（中等重要）
- **MySQL指標：** 每60秒（避免監控查詢影響性能）
- **網路品質：** 每30秒（重要，影響連線穩定性）

### 輸出格式
```csv
timestamp,metric_name,value,unit,node_info
2025-09-27T10:30:00Z,cpu_usage,45.2,percent,bench-1
2025-09-27T10:30:00Z,memory_used,6144,MB,bench-1
```

## 🚀 部署流程

### 階段1: 環境準備（5分鐘）
1. 在bench-1和test節點部署監控腳本
2. 確認監控工具可用性
3. 測試資料輸出格式

### 階段2: 監控執行（與測試同步）
1. MySQL測試開始前啟動監控
2. 背景持續採集數據
3. 測試結束後自動停止

### 階段3: 資料收集（5分鐘）
1. 打包各節點監控數據
2. 下載到本地分析環境
3. 驗證資料完整性

## 📁 監控檔案結構

```
monitoring/
├── monitoring-plan.md              # 監控計劃 (本文件)
├── scripts/
│   ├── bench-1-monitor.sh          # bench-1監控腳本
│   ├── test-monitor.sh             # test監控腳本
│   └── collect-data.sh             # 資料收集打包腳本
└── results/                        # 監控結果目錄
    ├── bench-1/
    │   ├── system_metrics.csv       # 系統資源數據
    │   ├── container_metrics.csv    # 容器資源數據
    │   └── mysql_metrics.csv        # MySQL應用數據
    └── test/
        ├── system_metrics.csv       # 系統資源數據
        ├── container_metrics.csv    # 容器資源數據
        └── network_metrics.csv      # 網路品質數據
```

## ⚠️ 重要注意事項

### 資源使用控制
- 監控腳本資源消耗最小化
- 避免影響測試性能結果
- 監控頻率適中，不過度採集

### 資料同步
- 各節點時間同步至關重要
- 統一時間戳格式
- 預留時間偏移校正機制

### 故障處理
- 監控腳本失敗不中斷測試
- 部分數據缺失可接受
- 提供手動資料收集備案

---

**建立日期：** 2025-09-27
**預估部署時間：** 10分鐘
**預估資料量：** 每節點約20-80MB（2小時測試）
**採集頻率：** 10秒（系統）/ 30秒（容器、網路）/ 60秒（MySQL）