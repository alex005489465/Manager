# Manager 系統完整部署與配置記錄

**日期**: 2025-09-26
**架構**: Cloudflare + Worker + AWS EC2 + MySQL
**域名**: example.com (前端) + api.example.com (後端)

## 🏗️ 系統架構概覽

**前端**: `https://example.com` (寵物食品工坊管理系統)
**API 代理**: Cloudflare Worker (`example.com/api/*`)
**後端**: `https://api.example.com` (AWS EC2)
**資料庫**: MySQL 9.4.0 (Docker)

## 📋 完整部署流程

### 階段 1: 本地開發環境準備

#### 1.1 Docker 配置調整
**問題**: 原有的 docker 目錄結構包含不需要的檔案
**解決方案**:
- 將 `docker/` 重命名為 `backend-service/`
- 清理空目錄：`mysql/conf/`, `mysql/ini/`, `volumes/`
- 移除不再使用的 `Dockerfile`（改用直接運行 JAR 方式）

#### 1.2 MySQL 初始化修復
**問題**: MySQL 容器啟動但沒有初始化資料
**原因**: 初始化腳本未正確掛載
**解決方案**:
- 在 `docker-compose.yml` 中添加初始化腳本掛載
- 修正資料庫連接配置：從 `manager` 改為 `manager_db` 和 `manager_reviews_db`
- 使用 `docker-compose down -v` 清除舊資料重新初始化

#### 1.3 編碼問題修復
**問題**: `.env` 檔案中文註解亂碼
**解決方案**: 重新以 UTF-8 編碼保存檔案

### 階段 2: Cloudflare Worker 設定

#### 2.1 Worker 開發與部署
**工具**: Wrangler CLI 4.40.0
**認證**: OAuth Token (your-email@gmail.com)

**操作流程**:
1. 檢查 CLI 安裝與認證狀態
2. 創建 Worker 腳本處理 `/api/*` 路由
3. 配置 `wrangler.toml` 設定路由規則
4. 部署到 Cloudflare Edge Network

**核心配置範例**:
```javascript
// Worker 腳本關鍵部分
const BACKEND_URL = 'https://api.example.com';
const WORKER_SECRET = 'your-domain-worker-secret-key';

// 添加認證 header 並轉發請求
headers.set('X-Worker-Secret', WORKER_SECRET);
headers.set('X-Forwarded-From', 'cloudflare-worker');
```

#### 2.2 SSL 憑證問題解決
**問題**: 錯誤 526 "Invalid SSL certificate"
**根本原因**: EC2 使用 Cloudflare Origin Certificate，但 CN 為 `*.example.com`，Worker 直接訪問 EC2 域名時 SNI 不匹配

**解決思路**:
1. 嘗試修改 Host header → 無效
2. 嘗試 resolveOverride 配置 → 無效
3. **最終方案**: 設定 DNS 子域名指向 EC2

#### 2.3 DNS 子域名配置
**設定**: `api.example.com` A record → `YOUR_EC2_IP`
**Proxy 狀態**: DNS only (橙色雲朵關閉)
**目的**: 讓 Worker 可以通過正確的域名訪問後端，符合 SSL 憑證的 SAN

### 階段 3: 雲端後端部署優化

#### 3.1 系統資源調整
**環境限制**: AWS EC2 ARM64 (3.7GB 記憶體)
**優化配置**:
- Java 堆記憶體: `1GB → 768MB`
- MySQL 緩衝池: `512MB → 256MB`
- 添加 Docker 記憶體限制

#### 3.2 容器服務配置
**服務組件**:
- Java 後端: Eclipse Temurin 21 JRE + Spring Boot
- MySQL 資料庫: MySQL 9.4.0 with 初始化資料
- 端口對應: 8082 (API), 8083 (管理), 3306 (資料庫)

**關鍵修復**:
- MySQL `lower_case_table_names` 相容性問題
- JVM 參數格式化
- 資料庫初始化腳本執行

### 階段 4: Nginx 反向代理與安全配置

#### 4.1 基礎代理設定
**配置檔案**: `/home/ec2-user/nginx/conf/nginx.conf`
**功能**: 將 `/api/*` 請求轉發到後端 Spring Boot 應用

#### 4.2 Worker 秘密認證實現
**安全策略**: 雙重驗證機制
- **Worker 端**: 添加 `X-Worker-Secret` 和 `X-Forwarded-From` header
- **Nginx 端**: 檢查秘密 header，不符合直接返回 403

**秘密密鑰**: `your-domain-worker-secret-key`

**Nginx 配置範例**:
```nginx
location /api/ {
    # 檢查 Worker 秘密 header
    if ($http_x_worker_secret != "your-domain-worker-secret-key") {
        return 403;
    }

    proxy_pass http://localhost:8082;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
```

#### 4.3 服務鎖定配置
**安全加固**:
- 關閉 HTTP 80 端口
- 禁用根路徑訪問（返回 404）
- 移除靜態檔案服務
- 僅允許 `/api/*` 且通過認證的請求

## 🔧 關鍵問題與解決思路

### 問題 1: SSL 憑證驗證失敗
**症狀**: Cloudflare 錯誤 526
**診斷方法**: 使用 `openssl s_client` 檢查憑證 SAN
**解決思路**: DNS 子域名 → 憑證域名匹配 → Worker 正常連接

### 問題 2: MySQL 初始化失敗
**症狀**: 容器啟動但無資料表
**診斷方法**: 檢查 Docker logs 和 volume 掛載
**解決思路**: 確保初始化腳本正確掛載 → 清除舊資料重新初始化

### 問題 3: 記憶體不足
**症狀**: 系統運行不穩定
**診斷方法**: 監控記憶體使用情況
**解決思路**: JVM 調優 + MySQL 配置調整 + Docker 資源限制

## 🛡️ 最終安全架構

### 訪問路徑控制
```
用戶請求 → example.com/api/*
         ↓
Cloudflare Worker (添加秘密 header)
         ↓
api.example.com (Nginx 檢查 header)
         ↓
localhost:8082 (Spring Boot API)
```

### 安全層級
1. **Cloudflare 層**: DDos 防護、Bot 管理
2. **Worker 層**: 路由控制、header 注入
3. **Nginx 層**: 秘密認證、路徑限制
4. **應用層**: Spring Security、業務邏輯驗證

## 📊 系統運行狀態

### 服務健康度
- **前端**: ✅ https://example.com (Cloudflare Pages)
- **API 代理**: ✅ https://example.com/api/food-items
- **後端**: ✅ https://api.example.com/api/* (需認證)
- **資料庫**: ✅ MySQL 9.4.0 (398 筆食物評論資料)

### 資源使用
- **記憶體**: 2.3GB / 3.7GB (62% 使用率)
- **容器狀態**: manager-backend (healthy), manager-mysql (healthy)
- **SSL 憑證**: Cloudflare Origin Certificate (有效至 2040-09-21)

## 🚀 部署成功驗證

### 功能測試
- ✅ 透過 Worker 代理訪問 API 正常
- ✅ 直接訪問後端被拒絕 (403)
- ✅ 錯誤認證被拒絕 (403)
- ✅ HTTP 訪問被拒絕 (連接失敗)

### 效能表現
- ✅ API 回應時間正常
- ✅ 記憶體使用穩定
- ✅ 無 502/504 錯誤

## 📝 未來維護要點

### 定期檢查項目
1. **SSL 憑證**: 2040 年前需更新
2. **記憶體監控**: 避免超過 80% 使用率
3. **Worker 秘密**: 定期輪換認證密鑰
4. **備份策略**: MySQL 資料定期備份

### 擴展考量
1. **負載平衡**: 如需要可增加多個後端實例
2. **快取策略**: 可在 Worker 層實現 API 回應快取
3. **監控告警**: 整合 Cloudflare Analytics 和 AWS CloudWatch
4. **自動部署**: 建立 CI/CD 管道自動化部署流程

---

## ⚠️ 敏感資訊說明

**此文檔中的域名、IP 地址、Email 等均為範例值，實際部署時請替換為你的真實資訊：**

- `example.com` → 你的實際域名
- `api.example.com` → 你的實際 API 子域名
- `YOUR_EC2_IP` → 你的 EC2 實際 IP 地址
- `your-email@gmail.com` → 你的 Cloudflare 帳號 Email
- `your-domain-worker-secret-key` → 你自定義的秘密密鑰

---

**部署完成日期**: 2025-09-26
**系統狀態**: 🟢 生產環境運行中
