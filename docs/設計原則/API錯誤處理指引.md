# API錯誤處理指引

## 📋 設計原則

**核心原則：**
- 不含具體程式碼，專注於錯誤處理格式設計
- **分層抽象架構**：後端專注業務邏輯，基礎設施層處理設備錯誤
- **統一200響應**：只要成功進出後端，就回應HTTP 200（包含內部異常）
- **問題定位優化**：HTTP狀態碼直接區分後端處理vs基礎設施問題

## 🚨 錯誤處理標準

### **錯誤回應結構**
- 統一JSON格式：`{ success: false, code, message, data }`
- 明確標示操作失敗狀態
- 提供系統內部錯誤代碼便於程式處理
- 包含使用者友善的錯誤說明

### **HTTP狀態碼標準**
- **後端統一回應：** 200 OK（表示成功進出後端伺服器）
- **業務狀態標示：** 透過JSON中的 `success` 字段區分成功/失敗
- **分層架構：**
  - **HTTP 200**：請求成功到達後端並獲得回應（包含業務成功、業務失敗、後端內部異常）
  - **HTTP 非200**：請求未能到達後端或後端無法回應（基礎設施問題）

### **錯誤分層分類**

**後端處理結果（HTTP 200 + success字段標示）：**
- **業務成功（success: true）**：操作成功完成
- **業務失敗（success: false）**：
  - 參數驗證：必填參數缺失、格式不正確
  - 業務規則：違反業務邏輯規則、資料狀態衝突
  - 權限控制：身份驗證失敗、操作權限不足
  - 資源狀態：資源不存在、資源已被使用
- **後端內部異常（success: false）**：
  - 資料庫連線失敗、查詢錯誤
  - 外部API呼叫失敗
  - 程式執行時異常、記憶體不足

**基礎設施錯誤（HTTP 非200）：**
- **網路層**：連線逾時、網路中斷（負載平衡器/代理處理）
- **服務層**：後端服務無法啟動、服務過載無法回應（負載平衡器/代理處理）

## 🔍 錯誤訊息設計

### **使用者訊息**
- 使用清晰易懂的語言
- 提供解決問題的具體建議
- 使用友善的語調，避免指責用戶

### **開發者訊息**
- 提供足夠的技術資訊便於除錯
- 使用統一的錯誤代碼系統
- 提供請求ID或其他追蹤資訊

## 🤝 分層架構協作

### **前端處理邏輯**
- **HTTP狀態判斷**：檢查是否為200，非200表示基礎設施問題
- **業務狀態檢查**：檢查JSON中的 `success` 字段判斷業務處理結果
- **錯誤處理流程**：
  1. HTTP 非200：顯示系統維護訊息，建議稍後重試
  2. HTTP 200 + success: false：顯示具體業務錯誤訊息

### **後端處理原則**
- **統一200回應**：只要成功進出後端伺服器就回應200（包含內部異常）
- **success字段標示**：透過 `success: true/false` 標示所有處理結果
- **錯誤詳細記錄**：在日誌中記錄詳細錯誤資訊，但不暴露給前端
- **異常統一處理**：後端內部異常（如資料庫錯誤）也回應200 + success: false

### **基礎設施層職責**
- **負載平衡器/代理**：處理服務健康檢查、流量分配、服務完全無法回應的情況
- **監控系統**：監控系統資源、網路狀態、服務可用性
- **日誌系統**：區分後端處理日誌（200響應）和基礎設施日誌（非200響應）

## ⚡ 設計考量

### **安全考量**
- 避免在錯誤訊息中洩露敏感系統資訊
- 嚴格驗證所有輸入，防止攻擊
- 對外部用戶限制錯誤詳細程度

### **效能考量**
- 盡早發現並回報錯誤
- 確保錯誤情況下正確釋放資源
- 提供適當的重試建議和限制

---

**版本：** v2.0.0
**建立日期：** 2025-09-01
**最後更新：** 2025-09-20
**重大變更：** 架構調整 - 後端統一200響應，分層抽象設計
**狀態：** ✅ 錯誤處理指引完成